#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1C CommerceML
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./test_commerce1c.sh [BASE_URL]

BASE_URL=${1:-"http://localhost:21080"}
USERNAME="admin"
PASSWORD="password123"

echo "üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1C CommerceML"
echo "URL: $BASE_URL"
echo "======================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è session_id –∏–∑ –æ—Ç–≤–µ—Ç–∞
extract_session_id() {
    echo "$1" | grep -o 'session_id=[^[:space:]]*' | cut -d'=' -f2
}

# 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
echo "1. üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
auth_response=$(curl -s -u "$USERNAME:$PASSWORD" "$BASE_URL/1c/?type=catalog&mode=checkauth")
echo "–û—Ç–≤–µ—Ç: $auth_response"

if [[ $auth_response == success* ]]; then
    echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞"
    SESSION_ID=$(extract_session_id "$auth_response")
    echo "Session ID: $SESSION_ID"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

echo ""

# 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
echo "2. üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
init_response=$(curl -s "$BASE_URL/1c/?type=catalog&mode=init&session_id=$SESSION_ID")
echo "–û—Ç–≤–µ—Ç: $init_response"

if [[ $init_response == success* ]]; then
    echo "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

echo ""

# 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ XML –∫–∞—Ç–∞–ª–æ–≥–∞
echo "3. üìÑ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ XML –∫–∞—Ç–∞–ª–æ–≥–∞..."
cat > /tmp/test_catalog.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –í–µ—Ä—Å–∏—è–°—Ö–µ–º—ã="2.05">
    <–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä>
        <–ò–¥>test-catalog</–ò–¥>
        <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
        <–ì—Ä—É–ø–ø—ã>
            <–ì—Ä—É–ø–ø–∞>
                <–ò–¥>test-cat-1</–ò–¥>
                <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
                <–û–ø–∏—Å–∞–Ω–∏–µ>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</–û–ø–∏—Å–∞–Ω–∏–µ>
            </–ì—Ä—É–ø–ø–∞>
        </–ì—Ä—É–ø–ø—ã>
    </–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä>
    <–ö–∞—Ç–∞–ª–æ–≥>
        <–ò–¥>test-catalog-1</–ò–¥>
        <–ò–¥–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞>test-catalog</–ò–¥–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞>
        <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–ö–∞—Ç–∞–ª–æ–≥</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
        <–¢–æ–≤–∞—Ä—ã>
            <–¢–æ–≤–∞—Ä>
                <–ò–¥>test-product-1</–ò–¥>
                <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
                <–û–ø–∏—Å–∞–Ω–∏–µ>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</–û–ø–∏—Å–∞–Ω–∏–µ>
                <–ê—Ä—Ç–∏–∫—É–ª>TEST-001</–ê—Ä—Ç–∏–∫—É–ª>
                <–ì—Ä—É–ø–ø—ã>
                    <–ò–¥>test-cat-1</–ò–¥>
                </–ì—Ä—É–ø–ø—ã>
            </–¢–æ–≤–∞—Ä>
        </–¢–æ–≤–∞—Ä—ã>
    </–ö–∞—Ç–∞–ª–æ–≥>
</–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è>
EOF

echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π XML –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω"

# 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
echo "4. üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞..."
file_response=$(curl -s -X POST \
    -H "Content-Type: application/xml; charset=utf-8" \
    --data-binary @/tmp/test_catalog.xml \
    "$BASE_URL/1c/?type=catalog&mode=file&filename=import0_1.xml&session_id=$SESSION_ID")

echo "–û—Ç–≤–µ—Ç: $file_response"

if [[ $file_response == success* ]]; then
    echo "‚úÖ –§–∞–π–ª –∫–∞—Ç–∞–ª–æ–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞"
    exit 1
fi

echo ""

# 5. –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞
echo "5. üìä –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞..."
import_response=$(curl -s "$BASE_URL/1c/?type=catalog&mode=import&filename=import0_1.xml&session_id=$SESSION_ID")
echo "–û—Ç–≤–µ—Ç: $import_response"

if [[ $import_response == success* ]]; then
    echo "‚úÖ –ö–∞—Ç–∞–ª–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞"
    exit 1
fi

echo ""

# 6. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ XML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
echo "6. üí∞ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ XML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π..."
cat > /tmp/test_offers.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –í–µ—Ä—Å–∏—è–°—Ö–µ–º—ã="2.05">
    <–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
        <–ò–¥>test-offers</–ò–¥>
        <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
        <–¢–∏–ø—ã–¶–µ–Ω>
            <–¢–∏–ø–¶–µ–Ω—ã>
                <–ò–¥>base-price</–ò–¥>
                <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–†–æ–∑–Ω–∏—á–Ω–∞—è</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
                <–í–∞–ª—é—Ç–∞>RUB</–í–∞–ª—é—Ç–∞>
            </–¢–∏–ø–¶–µ–Ω—ã>
        </–¢–∏–ø—ã–¶–µ–Ω>
        <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
            <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
                <–ò–¥>test-product-1</–ò–¥>
                <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>25</–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
                <–¶–µ–Ω—ã>
                    <–¶–µ–Ω–∞>
                        <–ò–¥–¢–∏–ø–∞–¶–µ–Ω—ã>base-price</–ò–¥–¢–∏–ø–∞–¶–µ–Ω—ã>
                        <–¶–µ–Ω–∞–ó–∞–ï–¥–∏–Ω–∏—Ü—É>199.99</–¶–µ–Ω–∞–ó–∞–ï–¥–∏–Ω–∏—Ü—É>
                        <–í–∞–ª—é—Ç–∞>RUB</–í–∞–ª—é—Ç–∞>
                    </–¶–µ–Ω–∞>
                </–¶–µ–Ω—ã>
            </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
        </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
    </–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
</–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è>
EOF

echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π XML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω"

# 7. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
echo "7. üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π..."
offers_file_response=$(curl -s -X POST \
    -H "Content-Type: application/xml; charset=utf-8" \
    --data-binary @/tmp/test_offers.xml \
    "$BASE_URL/1c/?type=catalog&mode=file&filename=offers0_1.xml&session_id=$SESSION_ID")

echo "–û—Ç–≤–µ—Ç: $offers_file_response"

if [[ $offers_file_response == success* ]]; then
    echo "‚úÖ –§–∞–π–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
    exit 1
fi

echo ""

# 8. –ò–º–ø–æ—Ä—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
echo "8. üíæ –ò–º–ø–æ—Ä—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π..."
offers_import_response=$(curl -s "$BASE_URL/1c/?type=catalog&mode=import&filename=offers0_1.xml&session_id=$SESSION_ID")
echo "–û—Ç–≤–µ—Ç: $offers_import_response"

if [[ $offers_import_response == success* ]]; then
    echo "‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
    exit 1
fi

echo ""

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -f /tmp/test_catalog.xml /tmp/test_offers.xml

echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
echo "======================================"
echo "–°–≤–æ–¥–∫–∞:"
echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
echo "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è"  
echo "‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞"
echo "‚úÖ –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞"
echo "‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
echo "‚úÖ –ò–º–ø–æ—Ä—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
echo ""
echo "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1C CommerceML —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! üöÄ"
