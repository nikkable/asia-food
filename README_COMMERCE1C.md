# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1C CommerceML

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–° –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É CommerceML 2.05 –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤, –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Ü–µ–Ω.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
context/Commerce1C/          # –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ interfaces/             # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ services/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ enums/                 # –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ parsers/               # XML –ø–∞—Ä—Å–µ—Ä—ã
‚îú‚îÄ‚îÄ config/                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ Bootstrap.php          # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ DI

repositories/Commerce1C/     # –ú–æ–¥–µ–ª–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
‚îú‚îÄ‚îÄ interfaces/             # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îú‚îÄ‚îÄ models/                # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ Commerce1CSyncRepository.php

backend/controllers/         # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îú‚îÄ‚îÄ CommerceMLController.php    # –û—Å–Ω–æ–≤–Ω–æ–π endpoint
‚îî‚îÄ‚îÄ TestCommerceController.php  # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```bash
cd /app
php yii migrate
```

–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –ø–æ–ª—è `external_id` –≤ —Ç–∞–±–ª–∏—Ü—ã `category` –∏ `product`.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–í —Ñ–∞–π–ª–µ `backend/config/bootstrap.php` –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```php
$config = new Commerce1CConfig(
    username: 'your_1c_username',
    password: 'your_1c_password',
    sessionTtlMinutes: 60,
    maxFileSize: 2097152, // 2MB
    version: '2.05'
);
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint

URL –¥–ª—è 1C: `http://your-domain/1c/`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ URL

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
   ```
   GET /test-commerce/test-auth
   ```

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
   ```
   GET /test-commerce/test-init?session_id={session_id}
   ```

3. **–ü—Ä–∏–º–µ—Ä XML –∫–∞—Ç–∞–ª–æ–≥–∞:**
   ```
   GET /test-commerce/sample-catalog-xml
   ```

4. **–ü—Ä–∏–º–µ—Ä XML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:**
   ```
   GET /test-commerce/sample-offers-xml
   ```

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å curl

```bash
# 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
curl -X GET "http://localhost:21080/1c/?type=catalog&mode=checkauth" \
  -u "admin:password123"

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å session_id –∏–∑ —à–∞–≥–∞ 1)
curl -X GET "http://localhost:21080/1c/?type=catalog&mode=init&session_id=SESSION_ID"

# 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
curl -X POST "http://localhost:21080/1c/?type=catalog&mode=file&filename=import0_1.xml&session_id=SESSION_ID" \
  -H "Content-Type: application/xml" \
  -d @catalog.xml

# 4. –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞
curl -X GET "http://localhost:21080/1c/?type=catalog&mode=import&filename=import0_1.xml&session_id=SESSION_ID"
```

## üìä –ü—Ä–æ—Ç–æ–∫–æ–ª CommerceML

### 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (checkauth)
- **URL:** `/?type=catalog&mode=checkauth`
- **–ú–µ—Ç–æ–¥:** GET/POST
- **Auth:** HTTP Basic Authentication
- **–û—Ç–≤–µ—Ç:** `success\nsession_id=xxx\nversion=2.05`

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (init)
- **URL:** `/?type=catalog&mode=init&session_id=xxx`
- **–ú–µ—Ç–æ–¥:** GET/POST
- **–û—Ç–≤–µ—Ç:** `success\nprogress\nsession_id=xxx`

### 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (file)
- **URL:** `/?type=catalog&mode=file&filename=import0_1.xml&session_id=xxx`
- **–ú–µ—Ç–æ–¥:** POST
- **Body:** XML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
- **–û—Ç–≤–µ—Ç:** `success`

### 4. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (import)
- **URL:** `/?type=catalog&mode=import&filename=import0_1.xml&session_id=xxx`
- **–ú–µ—Ç–æ–¥:** GET/POST
- **–û—Ç–≤–µ—Ç:** `success`

## üìÑ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã

### import0_1.xml - –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
```xml
<?xml version="1.0" encoding="UTF-8"?>
<–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –í–µ—Ä—Å–∏—è–°—Ö–µ–º—ã="2.05">
    <–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä>
        <–ì—Ä—É–ø–ø—ã>
            <–ì—Ä—É–ø–ø–∞>
                <–ò–¥>cat-1</–ò–¥>
                <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
            </–ì—Ä—É–ø–ø–∞>
        </–ì—Ä—É–ø–ø—ã>
    </–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä>
    <–ö–∞—Ç–∞–ª–æ–≥>
        <–¢–æ–≤–∞—Ä—ã>
            <–¢–æ–≤–∞—Ä>
                <–ò–¥>prod-1</–ò–¥>
                <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–¢–æ–≤–∞—Ä</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
                <–ì—Ä—É–ø–ø—ã><–ò–¥>cat-1</–ò–¥></–ì—Ä—É–ø–ø—ã>
            </–¢–æ–≤–∞—Ä>
        </–¢–æ–≤–∞—Ä—ã>
    </–ö–∞—Ç–∞–ª–æ–≥>
</–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è>
```

### offers0_1.xml - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
```xml
<?xml version="1.0" encoding="UTF-8"?>
<–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –í–µ—Ä—Å–∏—è–°—Ö–µ–º—ã="2.05">
    <–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
        <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
            <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
                <–ò–¥>prod-1</–ò–¥>
                <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>10</–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
                <–¶–µ–Ω—ã>
                    <–¶–µ–Ω–∞>
                        <–¶–µ–Ω–∞–ó–∞–ï–¥–∏–Ω–∏—Ü—É>100.00</–¶–µ–Ω–∞–ó–∞–ï–¥–∏–Ω–∏—Ü—É>
                        <–í–∞–ª—é—Ç–∞>RUB</–í–∞–ª—é—Ç–∞>
                    </–¶–µ–Ω–∞>
                </–¶–µ–Ω—ã>
            </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
        </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
    </–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
</–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è>
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 1–°

–í 1–° –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±–º–µ–Ω —Å —Å–∞–π—Ç–æ–º:

1. **URL —Å–∞–π—Ç–∞:** `http://your-domain/1c/`
2. **–õ–æ–≥–∏–Ω:** `admin` (–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
3. **–ü–∞—Ä–æ–ª—å:** `password123` (–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∂–∞—Ç–∏–µ:** –ù–µ—Ç
5. **–í–µ—Ä—Å–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:** 2.05

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **CSRF –æ—Ç–∫–ª—é—á–µ–Ω** –¥–ª—è CommerceMLController
2. **–°–µ—Å—Å–∏–∏** –∏–º–µ—é—Ç TTL 60 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
3. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** 2MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–æ–≥ Yii2
5. **external_id** –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –æ—à–∏–±–æ–∫
```bash
tail -f /app/backend/runtime/logs/app.log
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint
curl -I http://localhost:21080/1c/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
curl -u "admin:password123" http://localhost:21080/1c/?type=catalog&mode=checkauth
```

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

1. **Invalid credentials** - –Ω–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
2. **Invalid session** - –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è, –Ω—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
3. **File too large** - —Ñ–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç maxFileSize
4. **Invalid XML structure** - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ XML

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä—É–µ—Ç:
- –£—Å–ø–µ—à–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ XML
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤/–∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –ë–î

## üîÑ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:

1. **–ù–æ–≤—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:** –†–∞—Å—à–∏—Ä–∏—Ç—å XML –ø–∞—Ä—Å–µ—Ä—ã
2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
3. **–ù–æ–≤—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≤ context/
4. **–ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞:** –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ Commerce1CSyncRepository
